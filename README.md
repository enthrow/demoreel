# ðŸŽ¬ DemoReel

This is a [PyO3] module that parses .dem packet traces (demo-files) generated by
Source games using [demostf/parser][demostf], yields them as Python objects, and rolls
wheels using [maturin], motivated by the need for integration into
[MAC/Jensen][jensen].

Using this library, data storage and annotation can be decoupled from the batch
processing of the demo-files, avoiding the introduction of a domain-specific
format for training of AI models, and hopefully helping separate the concerns of
individual applications consuming such data from the pipelines producing and
ingesting it. 

## Installation

Haha, you thought. Nah, but this is actually a build section. You can only
install from source.

in the project root:
```sh
$ python3 -m venv venv # optional: create a virtual environment
$ . venv/bin/activate  # you can also activate a different one obviously
$ pip install maturin
$ maturin develop --release  # this should automatically build and install a wheel for you
```

This will build a wheel in the `targets/` subdirectory that you can `pip
install` in other virtual environments. Or if you prefer, you can just run your
application code in this source tree. Go ahead. I'm not the file police.

## Python Usage

```py
import concurrent.futures as cft
import demoreel
import polars as pl  # <- Arrow IPC instead of nested python dicts from "JSON"

demo_path = REPLACE_ME
with open(demo_path, "rb") as istrm:
    demo_data = istrm.read()


with cft.ThreadPoolExecutor() as pool:
    roster = demoreel.roster(demo_data)  # O(1) space, O(n) time
    bounds = demoreel.bounds(demo_data)  # O(1) space, O(n) time
    traces = demoreel.dtrace(demo_data)  # O(n) space, O(n) time
    cft.wait({roster, traces, bounds})   # -> all reduce to O(n) space, O(n) time
    traces = traces.result()
    bounds = bounds.result()
    roster = roster.result()
    # only the traces of a specific player
    source = roster.filter(~pl.col("is_fake_player"))["steam_id"][0]
    traces_of_source = demoreel.dtrace(demo_data, source)
    # traces with positions standardized over world boundaries
    traces_by_bounds = traces.with_columns(
        pl.col("position") / (bounds["boundary_max"] - bounds["boundary_min"])
    )
```

### TODO
- Surface additional wire metadata requested by @tomeno (https://github.com/demostf/parser/pull/13)
  - in_pvs
  - simtime
  - weapon types
  - etc, probably...
  - custom analyser?

[maturin]: https://maturin.rs/
[pyo3]: https://pyo3.rs/
[jpath]: https://docs.rs/serde_json_path/
[jensen]: https://github.com/megascatterbomb/MegaAntiCheat/
[demostf]: https://github.com/demostf/parser